rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Lettura pubblica dei contenuti del sito
    match /site/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    // Collezione artisti: lettura pubblica, scrittura admin o proprietario del profilo
    match /artisti/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isArtistOwner(docId);
    }
    match /artisti/{artistId}/tracks/{trackId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /musicaTracks/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /podcasts/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /countdowns/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Buy Music: generi e tracce
    match /buyGenres/{genreId} {
      // Le liste generi devono essere pubbliche sul sito
      allow read: if true;
      // Modifiche consentite solo agli admin
      allow write: if isAdmin();

      // Sottocollezione tracce per ogni genere
      match /tracks/{trackId} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }

    // Negare qualsiasi altra operazione per default
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}

function isAdmin() {
  // Consenti scrittura agli utenti con custom claim admin=true oppure a uno specifico UID
  return request.auth != null && (
    request.auth.token.admin == true ||
    request.auth.uid == 'QKWl9UFABzOOfXWwLzzmvtnnjGt1'
  );
}

function isArtistOwner(docId) {
  // Consente al creatore/proprietario (UID==docId) di aggiornare SOLO il proprio documento
  return request.auth != null && request.auth.uid == docId;
}
